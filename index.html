<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共同資料連線測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
    </style>
</head>
<body>

<div id="app" class="w-full max-w-md bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">
    <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
        Firestore 連線測試
    </h1>

    <div id="status-message" class="text-center p-3 mb-6 rounded-lg font-medium text-sm transition duration-300">
        正在初始化...
    </div>

    <div class="text-center mb-8">
        <p class="text-lg text-gray-600 mb-2">共同計數器的值：</p>
        <div id="counter-display" class="text-7xl font-extrabold text-indigo-600 p-4 bg-indigo-50 rounded-lg shadow-inner inline-block min-w-[100px]">
            0
        </div>
    </div>

    <button id="increment-button" disabled
            class="w-full py-3 px-4 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed transform hover:scale-[1.01] active:scale-[0.99]">
        點擊增加 (未連線)
    </button>
    
    <p class="mt-4 text-xs text-gray-500 text-center">
        使用者 ID: <span id="user-id" class="font-mono text-gray-700 break-all">N/A</span>
    </p>

</div>

<script type="module">
    // 導入 Firebase 模組
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"; // <-- FIX: setLogLevel 從這裡導入
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 必備的全域變數檢查與設定 ---
    // 應用程式 ID 和 Firebase 設定是運行環境提供的。
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // 設定 Firebase 服務變數
    let app, db, auth;
    let currentUserId = null;
    const COUNTER_PATH = `/artifacts/${appId}/public/data/debug_counter/main_count`;

    // UI 元素
    const statusMessage = document.getElementById('status-message');
    const counterDisplay = document.getElementById('counter-display');
    const incrementButton = document.getElementById('increment-button');
    const userIdDisplay = document.getElementById('user-id');

    // 輔助函數：更新狀態訊息
    function updateStatus(message, type = 'info') {
        let bgColor = 'bg-blue-100 text-blue-700';
        if (type === 'success') bgColor = 'bg-green-100 text-green-700';
        if (type === 'error') bgColor = 'bg-red-100 text-red-700';
        
        statusMessage.className = `text-center p-3 mb-6 rounded-lg font-medium text-sm transition duration-300 ${bgColor}`;
        statusMessage.textContent = message;
    }

    // 核心函數：初始化 Firebase 和執行認證
    async function initializeFirebaseAndAuthenticate() {
        try {
            // 啟用 Firebase 偵錯日誌
            setLogLevel('debug');
            
            // 1. 初始化 App
            updateStatus("初始化 Firebase...", 'info');
            if (Object.keys(firebaseConfig).length === 0) {
                 throw new Error("Firebase configuration is missing.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 2. 認證流程
            updateStatus("正在進行使用者認證...", 'info');
            if (initialAuthToken) {
                // 使用提供的 Custom Token 登入
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // 如果沒有 Token，則匿名登入
                await signInAnonymously(auth);
            }
            
            // 3. 監聽認證狀態變更 (確保 auth.currentUser 是最新的)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = currentUserId;
                    updateStatus("✅ 連線成功！正在載入資料...", 'success');
                    startDataListener(currentUserId);
                } else {
                    currentUserId = null;
                    userIdDisplay.textContent = 'N/A';
                    updateStatus("⚠️ 未認證或登入失敗。請檢查您的 Token。", 'error');
                }
            });

        } catch (error) {
            console.error("Firebase 初始化或認證錯誤:", error);
            updateStatus(`❌ 錯誤: ${error.message}. 請檢查 Console 訊息。`, 'error');
        }
    }

    // 核心函數：啟動即時資料監聽 (onSnapshot)
    function startDataListener(userId) {
        if (!db || !userId) {
            console.error("DB 或 User ID 不可用，無法啟動監聽。");
            return;
        }

        const docRef = doc(db, COUNTER_PATH);

        // 監聽文件變更
        onSnapshot(docRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                // 資料存在，更新計數器
                const data = docSnapshot.data();
                const count = data.value || 0;
                counterDisplay.textContent = count;
                updateStatus("✅ 資料連線正常。計數器已更新。", 'success');
            } else {
                // 文件不存在，初始化它 (設為 0)
                setDoc(docRef, { value: 0, initializedBy: userId, timestamp: new Date() }, { merge: true })
                    .then(() => {
                        updateStatus("✅ 資料庫文件已初始化為 0。", 'success');
                        counterDisplay.textContent = 0;
                    })
                    .catch(err => {
                        console.error("初始化文件時出錯:", err);
                        updateStatus("❌ 錯誤: 無法初始化計數器文件。", 'error');
                    });
            }
            // 成功連接後啟用按鈕
            incrementButton.disabled = false;
            incrementButton.textContent = "點擊增加";

        }, (error) => {
            console.error("Firestore 即時監聽錯誤 (onSnapshot):", error);
            // 這裡很可能是因為規則不允許讀取 (Permission denied)
            updateStatus("❌ 連線錯誤: 請檢查 Firestore 規則是否允許讀/寫。", 'error');
            incrementButton.disabled = true;
            incrementButton.textContent = "連線失敗，請檢查規則";
        });
    }

    // 核心函數：增加計數器 (交易操作更安全，但這裡用簡單寫入)
    async function incrementCounter() {
        if (!db) return;
        
        // 為了簡單起見，我們在這裡使用簡單的讀取和寫入，
        // 但在實際應用中，您應該使用交易 (Transaction) 來保證資料完整性。
        incrementButton.disabled = true;
        const docRef = doc(db, COUNTER_PATH);
        
        try {
            const docSnap = await getDoc(docRef);
            let newValue = 0;
            if (docSnap.exists()) {
                newValue = (docSnap.data().value || 0) + 1;
            } else {
                newValue = 1;
            }
            
            await setDoc(docRef, { value: newValue, lastUpdatedBy: currentUserId, timestamp: new Date() }, { merge: true });
            // onSnapshot 會自動更新 UI
            
        } catch (error) {
            console.error("增加計數器失敗:", error);
            updateStatus("❌ 寫入失敗！請檢查您的規則設定。", 'error');
        } finally {
            incrementButton.disabled = false;
        }
    }

    // 設置事件監聽器
    incrementButton.addEventListener('click', incrementCounter);

    // 網頁載入完成後開始執行
    window.onload = initializeFirebaseAndAuthenticate;

</script>

</body>
</html>