<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªæ—…éŠè¦åŠƒ App - æ¨™æº–ç‰ˆ (å”ä½œç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- è¼‰å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- è¼‰å…¥ Firebase å¿…è¦çš„ SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // å°‡ Firebase æ¨¡çµ„æš´éœ²çµ¦å…¨åŸŸç’°å¢ƒï¼Œä¾› Vue setup å­˜å–
        window.FirebaseServices = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* æ·ºç°è‰²èƒŒæ™¯ */
        }
        .app-container {
            min-height: 100vh;
            background-color: white; /* æ‡‰ç”¨ç¨‹å¼ä¸»é«”ç‚ºç™½è‰² */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .app-content {
            height: calc(100vh - 80px - 28px); /* åº•éƒ¨å°èˆªå’Œ user ID é¡¯ç¤º */
            overflow-y: auto;
        }
        .nav-button-active {
            color: #4f46e5; /* é›è—è‰² */
            border-top: 3px solid #4f46e5;
            background-color: #eff6ff;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .loading-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline {
            position: relative;
        }
        .timeline-line {
            position: absolute;
            top: 0;
            left: 17px; /* æ ¹æ“šåœ“é»å¤§å°èª¿æ•´ */
            width: 2px;
            height: 100%;
            background-color: #e5e7eb; /* ç°è‰²ç·šæ¢ */
            z-index: 0;
        }
        .timeline-item {
            position: relative;
            padding-left: 40px; /* ç‚ºåœ“é»é ç•™ç©ºé–“ */
            padding-bottom: 20px;
        }
        .timeline-marker {
            position: absolute;
            top: 0;
            left: 5px; /* ç·šæ¢å·¦å´ */
            width: 24px;
            height: 24px;
            border-radius: 50%;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white; /* è®“åœ“é»å‡¸é¡¯ */
        }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto app-container">
    
    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <header class="p-5 bg-indigo-600 text-white shadow-lg sticky top-0 z-10">
        <h1 class="text-xl font-bold text-center">âœˆï¸ å¤§é˜ªæ—…éŠè¦åŠƒå·¥å…· (å”ä½œç‰ˆ)</h1>
    </header>

    <!-- å…§å®¹å€åŸŸ -->
    <div v-if="isDataReady" class="p-4 app-content">
        <!-- 1. æ¯æ—¥è¡Œç¨‹è¡¨ (æ™‚é–“è»¸) -->
        <div v-if="currentTab === 'itinerary'" class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">è¡Œç¨‹è¦åŠƒ (æ™‚é–“è»¸)</h2>
            
            <!-- æ©«å‘æ»‘å‹•æ—¥æœŸé¸å–® -->
            <div class="flex overflow-x-scroll space-x-3 pb-3 snap-x scroll-smooth no-scrollbar">
                <div v-for="date in dateList" :key="date.full" @click="currentDate = date.full"
                     :class="{'bg-indigo-600 text-white shadow-lg': currentDate === date.full, 'bg-gray-100 text-gray-700 hover:bg-indigo-100': currentDate !== date.full}"
                     class="flex-shrink-0 w-24 p-3 text-center rounded-lg cursor-pointer transition duration-300 snap-center">
                    <p class="text-sm font-semibold">{{ date.dayOfWeek }}</p>
                    <p class="text-xs">{{ date.display }}</p>
                </div>
            </div>

            <!-- å¤©æ°£è³‡è¨Šå¡ç‰‡ -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg flex items-center space-x-4 shadow-md">
                <i data-lucide="cloud-sun" class="w-6 h-6 text-blue-600 flex-shrink-0"></i>
                <div>
                    <p class="font-medium text-gray-700">å¤§é˜ªæ°£æº«:</p>
                    <p :class="{'loading-pulse': weatherData === 'è¼‰å…¥ä¸­...' || weatherData === 'ç„¡æ³•è¼‰å…¥å¤©æ°£è³‡è¨Š'}" class="text-xl font-bold text-blue-800">{{ weatherData }}</p>
                </div>
            </div>

            <!-- æ–°å¢è¡Œç¨‹è¡¨å–® (åŒ…å«é¡åˆ¥å’Œå‚™è¨») -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-lg space-y-3">
                <h3 class="font-semibold text-lg mb-2 text-gray-800">æ–°å¢æ´»å‹• ({{ currentDateDisplay }})</h3>
                
                <select v-model="newItem.category" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">
                    <option disabled value="">é¸æ“‡æ´»å‹•é¡åˆ¥</option>
                    <option v-for="(cat, key) in categoryMap" :value="key" :key="key">
                        {{ cat.name }}
                    </option>
                </select>

                <input v-model="newItem.time" type="time" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                <input v-model="newItem.location" type="text" placeholder="åœ°é»/æ´»å‹•åç¨±" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                <input v-model="newItem.note" type="text" placeholder="å‚™è¨» (ä¾‹å¦‚: å¿…åƒç« é­šç‡’)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                
                <button @click="addItem" :disabled="!newItem.category || !newItem.location" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i data-lucide="plus" class="inline-block w-4 h-4 mr-1"></i> æ–°å¢è¡Œç¨‹
                </button>
            </div>

            <!-- è¡Œç¨‹æ™‚é–“è»¸åˆ—è¡¨ -->
            <div class="timeline">
                <div class="timeline-line"></div>
                <div v-for="(item, index) in filteredItinerary" :key="item.id" class="timeline-item">
                    
                    <!-- æ™‚é–“è»¸åœ“é»æ¨™è¨˜ (åƒ…é¡è‰²) -->
                    <div class="timeline-marker shadow-md" :class="getCategoryInfo(item.category).bg">
                        <!-- åœ–ç¤ºå·²ç§»è‡³æ´»å‹•åç¨±æ— -->
                    </div>

                    <!-- è¡Œç¨‹å…§å®¹å¡ç‰‡ -->
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 transition duration-200 hover:shadow-xl ml-2">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="font-extrabold text-2xl text-indigo-700">{{ item.time }}</span>
                                <span class="text-sm text-gray-500">({{ getCategoryInfo(item.category).name }})</span>
                            </div>
                            <div class="flex space-x-2 flex-shrink-0">
                                <!-- ç·¨è¼¯æŒ‰éˆ• -->
                                <button @click="editItem(item.id)" class="text-indigo-500 p-1 rounded-full hover:bg-indigo-100 transition">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <!-- åˆªé™¤æŒ‰éˆ• -->
                                <button @click="deleteItem(item.id)" class="text-red-500 p-1 rounded-full hover:bg-red-100 transition">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        
                        <p class="text-xl font-semibold text-gray-800 mb-1 flex items-center">
                            <!-- Category Icon ç§»åˆ°é€™è£¡ -->
                            <i :data-lucide="getCategoryInfo(item.category).icon" class="w-5 h-5 mr-2" :class="getCategoryInfo(item.category).color"></i>
                            {{ item.location }}
                        </p>
                        
                        <p v-if="item.note" class="text-sm text-gray-600 border-t pt-2 mt-2">
                            <span class="font-medium text-gray-700">å‚™è¨»:</span> {{ item.note }}
                        </p>
                    </div>
                </div>
                <p v-if="filteredItinerary.length === 0" class="text-center text-gray-500 pt-4 p-4 rounded-xl bg-gray-100">æ­¤æ—¥æœŸæš«ç„¡è¡Œç¨‹ï¼Œé–‹å§‹è¦åŠƒå§ï¼</p>
            </div>
            
             <!-- ç·¨è¼¯è¡Œç¨‹ Modal (åŒ…å«é¡åˆ¥å’Œå‚™è¨») -->
             <div v-if="editingItem !== null" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs space-y-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">ç·¨è¼¯è¡Œç¨‹</h3>
                    
                    <select v-model="editingItem.category" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">
                        <option v-for="(cat, key) in categoryMap" :value="key" :key="key">
                            {{ cat.name }}
                        </option>
                    </select>

                    <input v-model="editingItem.time" type="time" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="æ™‚é–“">
                    <input v-model="editingItem.location" type="text" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="åœ°é»">
                    <input v-model="editingItem.note" type="text" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="å‚™è¨»">
                    
                    <div class="flex justify-end space-x-3 pt-2">
                        <button @click="cancelEdit" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">å–æ¶ˆ</button>
                        <button @click="saveEdit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. åˆ†å¸³ç³»çµ± -->
        <div v-if="currentTab === 'splitter'" class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">æ—…éŠåˆ†å¸³çµç®—</h2>
            
            <!-- åŒ¯ç‡è³‡è¨Šå¡ç‰‡ -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg flex items-center space-x-4 shadow-md">
                <i data-lucide="trending-up" class="w-6 h-6 text-yellow-600 flex-shrink-0"></i>
                <div>
                    <p class="font-medium text-gray-700">ç•¶å‰åŒ¯ç‡ JPY -> TWD:</p>
                    <p :class="{'loading-pulse': exchangeRateText === 'è¼‰å…¥ä¸­...'}" class="text-xl font-bold text-yellow-800">
                        1 JPY â‰ˆ {{ exchangeRateText }} TWD
                    </p>
                </div>
            </div>
            
            <!-- åƒèˆ‡è€…è¨­å®š -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-lg space-y-3">
                <h3 class="font-semibold text-lg text-gray-800">åƒèˆ‡è€…</h3>
                <div class="flex space-x-2">
                    <input v-model="newPersonName" type="text" placeholder="è¼¸å…¥äººå" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <button @click="addPerson" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md">æ–°å¢</button>
                </div>
                <div class="flex flex-wrap gap-2 pt-2">
                    <span v-for="person in people" :key="person" class="bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1 rounded-full flex items-center">
                        {{ person }}
                        <i data-lucide="x" class="w-4 h-4 ml-2 cursor-pointer text-indigo-500 hover:text-indigo-700" @click="removePerson(person)"></i>
                    </span>
                </div>
                <p v-if="people.length === 0" class="text-sm text-red-500">è«‹è‡³å°‘æ–°å¢ä¸€ä½åƒèˆ‡è€…æ‰èƒ½è¨˜éŒ„æ”¯å‡ºã€‚</p>
            </div>

            <!-- æ–°å¢æ”¯å‡ºè¡¨å–® -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-lg space-y-3">
                <h3 class="font-semibold text-lg text-gray-800">æ–°å¢æ”¯å‡º</h3>
                
                <div>
                    <label class="block font-medium text-sm mb-1 text-gray-700">é‡‘é¡ (JPY/æ—¥åœ“)</label>
                    <input v-model.number="newExpense.amount" type="number" placeholder="æ—¥åœ“é‡‘é¡" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" min="0">
                    <p v-if="exchangeRate > 0 && newExpense.amount > 0" class="text-sm text-green-600 mt-1">
                        ç´„ç­‰æ–¼: {{ formatCurrencyTWD(twdAmount) }} TWD
                    </p>
                </div>

                <input v-model="newExpense.description" type="text" placeholder="èªªæ˜ (ä¾‹å¦‚: æ™šé¤)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                <select v-model="newExpense.paidBy" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">
                    <option disabled value="">èª°ä»˜çš„éŒ¢?</option>
                    <option v-for="person in people" :value="person" class="text-gray-800">{{ person }}</option>
                </select>
                <div class="space-y-1">
                    <label class="block font-medium text-sm text-gray-700">å…±åŒåˆ†å¸³è€…ï¼š</label>
                    <div class="flex flex-wrap gap-2">
                        <label v-for="person in people" :key="person" class="flex items-center space-x-2 bg-gray-100 px-3 py-1 rounded-lg hover:bg-indigo-100 cursor-pointer">
                            <input type="checkbox" :value="person" v-model="newExpense.participants" class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-gray-700">{{ person }}</span>
                        </label>
                    </div>
                </div>
                <button @click="addExpense" :disabled="!isExpenseValid" class="w-full p-3 rounded-lg font-semibold transition duration-150 shadow-md"
                    :class="{'bg-indigo-600 text-white hover:bg-indigo-700': isExpenseValid, 'bg-gray-400 text-gray-200 cursor-not-allowed': !isExpenseValid}">
                    è¨˜éŒ„æ”¯å‡º (JPY)
                </button>
            </div>

            <!-- æ”¯å‡ºç´€éŒ„åˆ—è¡¨ (æ–°å¢çš„å€å¡Šï¼Œè®“æ‚¨çœ‹åˆ°å·²è¨˜éŒ„çš„é …ç›®) -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-lg space-y-3">
                <h3 class="font-semibold text-xl text-gray-800 flex items-center justify-between">
                    <span>ğŸ§¾ æ”¯å‡ºç´€éŒ„ ({{ expenses.length }})</span>
                </h3>
                <div v-if="expenses.length > 0" class="space-y-3">
                    <div v-for="expense in expenses" :key="expense.id" class="p-3 border border-gray-100 rounded-lg bg-gray-50 flex justify-between items-start">
                        <div class="flex-grow pr-4">
                            <p class="font-extrabold text-lg text-gray-800">{{ formatCurrencyJPY(expense.amount) }}</p>
                            <p class="font-medium text-sm text-indigo-700">{{ expense.description }}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                ç”± <span class="font-semibold">{{ expense.paidBy }}</span> å¢Šä»˜
                                (åƒèˆ‡è€…: <span class="text-indigo-500">{{ expense.participants.join(', ') }}</span>)
                            </p>
                        </div>
                        <button @click="removeExpense(expense.id)" class="text-red-400 hover:text-red-600 transition p-1 rounded-full flex-shrink-0" aria-label="åˆªé™¤æ”¯å‡º">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <p v-else class="text-center text-gray-500 text-sm">ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„ã€‚</p>
            </div>

            <!-- çµç®—çµæœ -->
            <div class="bg-green-50 p-4 rounded-xl shadow-lg space-y-3 border-l-4 border-green-500">
                <h3 class="text-xl font-bold text-gray-800 flex items-center justify-between">
                    <span>ğŸ“ çµç®—çµæœ (æ—¥åœ“)</span>
                    <button @click="clearExpenses" class="text-sm text-red-500 hover:text-red-700 p-1 rounded-lg">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
                </h3>
                
                <div v-if="settlements.length > 0" class="space-y-3">
                    <p class="text-green-700 font-semibold">ç¸½è¨ˆï¼š{{ formatCurrencyJPY(totalAmount) }} (æ¯äººå¹³å‡ç´„ {{ formatCurrencyJPY(averageCost) }})</p>
                    
                    <div v-for="(settlement, index) in settlements" :key="index" class="bg-white p-3 rounded-lg border border-gray-200">
                        <p class="font-semibold text-gray-700">{{ settlement.debtor }} <i data-lucide="arrow-right" class="inline-block w-4 h-4 mx-1 text-indigo-500"></i> {{ settlement.creditor }}</p>
                        <p class="text-sm text-gray-500">æ‡‰ä»˜é‡‘é¡: <span class="text-xl font-extrabold text-green-600">{{ formatCurrencyJPY(settlement.amount) }}</span></p>
                    </div>
                </div>
                <p v-else class="text-center text-gray-500">è«‹æ–°å¢æ”¯å‡ºä»¥é€²è¡Œåˆ†å¸³çµç®—ã€‚</p>
            </div>
        </div>

        <!-- 3. åœ°åœ–èˆ‡å°èˆª -->
        <div v-if="currentTab === 'map'" class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">åœ°åœ–èˆ‡å°èˆª</h2>
            
            <!-- å°åœ°åœ–å‘ˆç¾ -->
            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                <h3 class="font-semibold text-lg mb-3 text-gray-800">ğŸ“Œ ä»Šæ—¥è¡Œç¨‹åœ°åœ– ({{ currentDateDisplay }})</h3>
                
                <div v-if="filteredItinerary.length > 0" class="w-full rounded-lg overflow-hidden border-2 border-indigo-400 shadow-xl" style="height: 250px;">
                    <!-- Google Maps Embed Iframe -->
                    <iframe 
                        :src="mapEmbedUrl" 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        style="border:0;" 
                        allowfullscreen="" 
                        loading="lazy" 
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
                <div v-else class="text-center p-6 bg-gray-100 rounded-lg text-gray-500">
                    <i data-lucide="map-pin-off" class="w-8 h-8 mx-auto text-red-400 mb-2"></i>
                    <p class="font-medium">ä»Šæ—¥æ²’æœ‰è¡Œç¨‹ï¼Œåœ°åœ–é è¨­é¡¯ç¤ºå¤§é˜ªåŸã€‚</p>
                </div>
            </div>

            <!-- æ¯æ—¥è¡Œç¨‹å°èˆª -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-lg space-y-3">
                <h3 class="font-semibold text-lg mb-3 text-gray-800">ğŸ—ºï¸ å°èˆªä»Šæ—¥è¡Œç¨‹åœ°é»</h3>
                <div class="text-sm text-gray-600">
                    <p v-if="filteredItinerary.length > 0">å·²é¸å®š {{ filteredItinerary.length }} å€‹åœ°é»</p>
                    <p v-else class="text-red-500">ä»Šæ—¥ç„¡è¡Œç¨‹å¯å°èˆªã€‚</p>
                </div>
                <button @click="openItineraryMap" :disabled="filteredItinerary.length === 0"
                    class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold transition duration-150 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-indigo-700">
                    <i data-lucide="route" class="inline-block w-4 h-4 mr-1"></i> å°èˆªæ‰€æœ‰ä»Šæ—¥è¡Œç¨‹
                </button>
            </div>

            <!-- ç•¶å‰ä½ç½®é¡¯ç¤º -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-lg space-y-3">
                <h3 class="font-semibold text-lg mb-3 text-gray-800">ğŸ“ é¡¯ç¤ºæˆ‘çš„ç•¶å‰ä½ç½®</h3>
                <button @click="getCurrentLocation" 
                    class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                    <i data-lucide="locate" class="inline-block w-4 h-4 mr-1"></i> ç²å–æˆ‘çš„ä½ç½®
                </button>
                <div v-if="userLatitude && userLongitude" class="bg-green-100 text-green-800 p-3 rounded-lg text-sm border border-green-300 space-y-1">
                    <p class="font-medium">ç¶“åº¦: <span class="font-mono">{{ userLongitude.toFixed(6) }}</span></p>
                    <p class="font-medium">ç·¯åº¦: <span class="font-mono">{{ userLatitude.toFixed(6) }}</span></p>
                    <p class="text-xs text-green-600">ä½ç½®å·²æˆåŠŸç²å–ï¼</p>
                </div>
                <div v-if="locationError" class="bg-red-100 text-red-800 p-3 rounded-lg text-sm border border-red-300">
                    éŒ¯èª¤: {{ locationError }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥ä¸­/éŒ¯èª¤ç•«é¢ -->
    <div v-else class="flex flex-col items-center justify-center p-10 h-[80vh]">
        <div v-if="loadingError" class="text-center p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
            <p class="font-bold mb-2">è³‡æ–™è¼‰å…¥å¤±æ•—</p>
            <p class="text-sm">{{ loadingError }}</p>
            <p class="text-xs mt-2">è«‹æª¢æŸ¥ Firebase å®‰å…¨è¦å‰‡è¨­å®šæ˜¯å¦æ­£ç¢ºã€‚</p>
        </div>
        <div v-else class="flex flex-col items-center">
            <div class="spinner border-4 border-gray-200 border-t-indigo-600 rounded-full w-12 h-12 mb-3 animate-spin"></div>
            <p class="text-gray-600 font-medium">æ­£åœ¨è¼‰å…¥é›²ç«¯è³‡æ–™ä¸¦é€²è¡Œé©—è­‰...</p>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 shadow-xl z-20 h-20 p-2">
        <div class="flex justify-around items-center h-full">
            <button @click="currentTab = 'itinerary'" 
                    :class="{'nav-button-active text-indigo-600': currentTab === 'itinerary', 'text-gray-500 hover:bg-gray-100': currentTab !== 'itinerary'}"
                    class="flex flex-col items-center p-2 rounded-lg text-xs font-medium transition duration-200 w-1/3 h-full justify-center">
                <i data-lucide="calendar-check" class="w-6 h-6 mb-1"></i>
                <span>è¡Œç¨‹</span>
            </button>
            <button @click="currentTab = 'splitter'" 
                    :class="{'nav-button-active text-indigo-600': currentTab === 'splitter', 'text-gray-500 hover:bg-gray-100': currentTab !== 'splitter'}"
                    class="flex flex-col items-center p-2 rounded-lg text-xs font-medium transition duration-200 w-1/3 h-full justify-center">
                <i data-lucide="users" class="w-6 h-6 mb-1"></i>
                <span>åˆ†å¸³</span>
            </button>
            <button @click="currentTab = 'map'" 
                    :class="{'nav-button-active text-indigo-600': currentTab === 'map', 'text-gray-500 hover:bg-gray-100': currentTab !== 'map'}"
                    class="flex flex-col items-center p-2 rounded-lg text-xs font-medium transition duration-200 w-1/3 h-full justify-center">
                <i data-lucide="map" class="w-6 h-6 mb-1"></i>
                <span>åœ°åœ–</span>
            </button>
        </div>
    </nav>
    <!-- ä½¿ç”¨è€… ID é¡¯ç¤º (æ–¹ä¾¿å”ä½œ) -->
    <div v-if="userId" class="fixed bottom-[80px] left-0 right-0 max-w-md mx-auto text-center text-xs text-gray-400 bg-gray-50 py-0.5 border-t border-gray-200 shadow-inner">
        å”ä½œç”¨æˆ¶ ID: <span class="font-mono text-gray-600">{{ userId }}</span>
    </div>
</div>

<script type="module">
    const { createApp, ref, computed, nextTick, reactive, onMounted, watch } = Vue;

    // Firebase æœå‹™å°‡å¾å…¨å±€ window.FirebaseServices ç²å–
    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, setLogLevel } = window.FirebaseServices;

    // --- è¼”åŠ©å‡½æ•¸ ---
    const formatDate = (date) => {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const getDayName = (date) => {
        const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
        return days[new Date(date).getDay()];
    };

    // --- æŒ‡æ•¸é€€é¿é‡è©¦é‚è¼¯ (èˆ‡ API ç›¸é—œ) ---
    const retryFetch = async (url, options, maxRetries = 3) => {
        let lastError = null;
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                return result; 
            } catch (error) {
                lastError = error;
                console.error(`Attempt ${attempt + 1} failed:`, error);
                if (attempt < maxRetries - 1) {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        throw new Error("Failed to fetch data after multiple retries. Last error: " + lastError.message);
    };

    // --- è¡Œç¨‹é¡åˆ¥é…ç½® ---
    const categoryMap = {
        'flight': { name: 'èˆªç­', icon: 'plane', color: 'text-blue-500', bg: 'bg-blue-500' },
        'food': { name: 'ç¾é£Ÿ', icon: 'utensils', color: 'text-red-500', bg: 'bg-red-500' },
        'shopping': { name: 'è³¼ç‰©', icon: 'shopping-bag', color: 'text-purple-500', bg: 'bg-purple-500' },
        'attraction': { name: 'æ™¯é»', icon: 'map-pin', color: 'text-green-500', bg: 'bg-green-500' },
        'accommodation': { name: 'ä½å®¿', icon: 'hotel', color: 'text-yellow-700', bg: 'bg-yellow-500' },
        'other': { name: 'å…¶ä»–', icon: 'list-todo', color: 'text-gray-500', bg: 'bg-gray-500' }
    };


    const App = {
        setup() {
            // --- Firebase ç‹€æ…‹ ---
            const userId = ref(null);
            const isAuthReady = ref(false);
            const isDataReady = ref(false);
            const loadingError = ref(null);
            
            let db = null;
            let itinerariesColRef = null;
            let expensesColRef = null;
            let peopleDocRef = null; // å–®ç¨çš„æ–‡ä»¶ä¾†å­˜å„²åƒèˆ‡è€…åˆ—è¡¨
            
            const PEOPLE_DOC_ID = 'participants';

            // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
            const currentTab = ref('itinerary');
            const today = new Date();
            const currentDate = ref(formatDate(today)); 
            const editingItem = ref(null); 
            
            // Firebase ç¶å®šçš„éŸ¿æ‡‰å¼è³‡æ–™
            const itinerary = ref([]);
            const people = ref([]);
            const expenses = ref([]);

            const newItem = ref({ time: '12:00', location: '', category: '', note: '' });

            // --- Firebase åˆå§‹åŒ–èˆ‡è³‡æ–™åŒæ­¥é‚è¼¯ ---
            const initFirebase = async () => {
                try {
                    setLogLevel('debug'); // é–‹å•Ÿ Firebase åµéŒ¯æ—¥èªŒ
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    db = getFirestore(app);

                    // 1. é€²è¡Œä½¿ç”¨è€…èªè­‰
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    // 2. ç›£è½èªè­‰ç‹€æ…‹ï¼Œç²å– userId ä¸¦æ¨™è¨˜ AuthReady
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId.value = user.uid;
                            isAuthReady.value = true;
                            // 3. è¨­ç½® Firestore é›†åˆåƒè€ƒ (ä½¿ç”¨ Public å…±äº«è·¯å¾‘)
                            const basePath = `artifacts/${appId}/public/data`;
                            itinerariesColRef = collection(db, `${basePath}/itineraries`);
                            expensesColRef = collection(db, `${basePath}/expenses`);
                            peopleDocRef = doc(db, `${basePath}/people`, PEOPLE_DOC_ID);
                            
                            // 4. å•Ÿå‹•å³æ™‚è³‡æ–™ç›£è½
                            setupFirestoreListeners();
                        } else {
                            // æ‡‰è©²ä¸æœƒç™¼ç”Ÿï¼Œå› ç‚ºæˆ‘å€‘å¼·åˆ¶åŒ¿åç™»å…¥
                            console.error("User not authenticated.");
                            isAuthReady.value = false;
                            isDataReady.value = false;
                        }
                    });

                } catch (error) {
                    loadingError.value = `Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`;
                    console.error("Firebase Initialization Error:", error);
                }
            };
            
            const setupFirestoreListeners = () => {
                if (!isAuthReady.value || !db) return;
                
                let listenersCompleted = 0;
                const requiredListeners = 3;
                const checkCompletion = () => {
                    listenersCompleted++;
                    if (listenersCompleted === requiredListeners) {
                        isDataReady.value = true;
                        nextTick(() => lucide.createIcons());
                    }
                };

                // a) ç›£è½ è¡Œç¨‹ (itineraries)
                onSnapshot(itinerariesColRef, (snapshot) => {
                    const items = [];
                    snapshot.forEach(doc => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    itinerary.value = items;
                    checkCompletion();
                }, (error) => {
                    loadingError.value = `è¡Œç¨‹è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`;
                    checkCompletion();
                });

                // b) ç›£è½ æ”¯å‡º (expenses)
                onSnapshot(expensesColRef, (snapshot) => {
                    const items = [];
                    snapshot.forEach(doc => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    expenses.value = items;
                    checkCompletion();
                }, (error) => {
                    loadingError.value = `æ”¯å‡ºè³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`;
                    checkCompletion();
                });
                
                // c) ç›£è½ åƒèˆ‡è€… (peopleDocRef)
                onSnapshot(peopleDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        people.value = data.names || [];
                    } else {
                        // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¨­ç½®ä¸€å€‹ç©ºçš„åˆ—è¡¨ (ä¸¦åœ¨å¾ŒçºŒæ–°å¢æ™‚å»ºç«‹æ–‡ä»¶)
                        people.value = []; 
                    }
                    checkCompletion();
                }, (error) => {
                    loadingError.value = `åƒèˆ‡è€…è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`;
                    checkCompletion();
                });
            };

            // --- 1. è¡Œç¨‹è¦åŠƒ CRUD ---
            
            const addItem = async () => {
                if (!isDataReady.value || !newItem.value.time || !newItem.value.location || !newItem.value.category) return;
                try {
                    const itemData = {
                        date: currentDate.value, 
                        time: newItem.value.time, 
                        location: newItem.value.location, 
                        category: newItem.value.category, 
                        note: newItem.value.note,
                        createdAt: Date.now(), // ç”¨æ–¼æ’åº
                        createdBy: userId.value,
                    };
                    await addDoc(itinerariesColRef, itemData);
                    // é‡è¨­éƒ¨åˆ†æ¬„ä½
                    newItem.value.location = '';
                    newItem.value.note = '';
                    // ä¿æŒ category é è¨­å€¼ä¸è®Š
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            };

            const deleteItem = async (itemId) => {
                if (!isDataReady.value) return;
                try {
                    await deleteDoc(doc(itinerariesColRef, itemId));
                } catch (e) {
                    console.error("Error deleting document: ", e);
                }
            };

            const saveEdit = async () => {
                if (!isDataReady.value || !editingItem.value.category || !editingItem.value.location) return;

                const id = editingItem.value.id;
                // ç§»é™¤ id å±¬æ€§å¾Œå†æ›´æ–°
                const { id: _, ...dataToUpdate } = editingItem.value; 

                try {
                    await updateDoc(doc(itinerariesColRef, id), dataToUpdate);
                    editingItem.value = null;
                } catch (e) {
                    console.error("Error updating document: ", e);
                }
            };
            
            // --- 2. åˆ†å¸³ç³»çµ± CRUD (People & Expenses) ---

            const addPerson = async () => {
                if (!isDataReady.value) return;
                const name = newPersonName.value.trim();
                if (name && !people.value.includes(name)) {
                    const updatedPeople = [...people.value, name];
                    try {
                        // ä½¿ç”¨ setDoc åˆä½µæ›´æ–°ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨å‰‡å»ºç«‹
                        await setDoc(peopleDocRef, { names: updatedPeople }, { merge: true });
                        newPersonName.value = '';
                    } catch (e) {
                        console.error("Error adding person: ", e);
                    }
                }
            };

            const removePerson = async (personToRemove) => {
                if (!isDataReady.value) return;
                
                const updatedPeople = people.value.filter(p => p !== personToRemove);
                
                try {
                    // 1. æ›´æ–°åƒèˆ‡è€…åˆ—è¡¨
                    await setDoc(peopleDocRef, { names: updatedPeople }, { merge: true });

                    // 2. æ‰¹é‡æ›´æ–°å—å½±éŸ¿çš„æ”¯å‡ºè¨˜éŒ„ (é€™åœ¨ Firestore ä¸­ç¨å¾®è¤‡é›œï¼Œé€™è£¡åªè™•ç† people åˆ—è¡¨æœ¬èº«)
                    // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦é€šçŸ¥ä½¿ç”¨è€…æ‰‹å‹•æª¢æŸ¥/ä¿®æ­£ç›¸é—œæ”¯å‡ºã€‚
                    // é€™è£¡å…ˆç°¡å–®è™•ç†ï¼Œç¢ºä¿ UI çš„ people åˆ—è¡¨æ­£ç¢ºã€‚
                } catch (e) {
                    console.error("Error removing person: ", e);
                }
            };

            const addExpense = async () => {
                if (!isDataReady.value || !isExpenseValid.value) return;
                try {
                    const expenseData = {
                        amount: newExpense.amount,
                        description: newExpense.description,
                        paidBy: newExpense.paidBy,
                        participants: newExpense.participants,
                        createdAt: Date.now(),
                        createdBy: userId.value,
                    };
                    await addDoc(expensesColRef, expenseData);
                    
                    // é‡è¨­è¡¨å–®
                    Object.assign(newExpense, { amount: null, description: '', paidBy: '', participants: [] });
                } catch (e) {
                    console.error("Error adding expense: ", e);
                }
            };

            const removeExpense = async (expenseId) => {
                if (!isDataReady.value) return;
                try {
                    await deleteDoc(doc(expensesColRef, expenseId));
                } catch (e) {
                    console.error("Error deleting expense: ", e);
                }
            };

            const clearExpenses = async () => {
                 if (!isDataReady.value) return;
                 // æ‰¹æ¬¡åˆªé™¤ (éœ€æ‰‹å‹•å¯¦ç¾ï¼Œé€™è£¡æˆ‘å€‘åªæ˜¯æ¸…é™¤ Vue ç‹€æ…‹ï¼Œä½†å¯¦éš›æ‡‰åˆªé™¤ Firestore æ–‡ä»¶)
                 // ç”±æ–¼æˆ‘å€‘ä¸èƒ½åœ¨æ‰¹æ¬¡ä¸­é€²è¡ŒæŸ¥è©¢ï¼Œé€™è£¡åªèƒ½æä¾›ä¸€å€‹ç°¡å–®çš„æç¤ºï¼Œé¼“å‹µä½¿ç”¨ deleteDoc
                 console.log("Warning: Clearing all expenses requires batch delete. Please implement batch delete in a production environment.");
                 
                 // ç‚ºäº†åŠŸèƒ½é‹è¡Œï¼Œæˆ‘å€‘å°‡æ¯å€‹æ–‡ä»¶é€ä¸€åˆªé™¤
                 expenses.value.forEach(async (exp) => {
                     try {
                         await deleteDoc(doc(expensesColRef, exp.id));
                     } catch (e) {
                         console.error("Error batch deleting expense:", exp.id, e);
                     }
                 });
            };
            
            // --- è¼”åŠ©è¨ˆç®—å±¬æ€§èˆ‡å‡½æ•¸ ---

            const dateList = computed(() => {
                const dates = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    dates.push({
                        full: formatDate(d),
                        display: `${d.getMonth() + 1}/${d.getDate()}`,
                        dayOfWeek: getDayName(d),
                    });
                }
                return dates;
            });
            
            const currentDateDisplay = computed(() => {
                const dateObj = dateList.value.find(d => d.full === currentDate.value);
                return dateObj ? `${dateObj.display} (${dateObj.dayOfWeek})` : currentDate.value;
            });

            const filteredItinerary = computed(() => {
                return itinerary.value
                    .filter(item => item.date === currentDate.value)
                    .sort((a, b) => (a.time > b.time ? 1 : -1));
            });

            const getCategoryInfo = (categoryKey) => {
                return categoryMap[categoryKey] || categoryMap['other'];
            };
            
            const editItem = (itemId) => {
                const itemToEdit = itinerary.value.find(item => item.id === itemId);
                if (itemToEdit) {
                    editingItem.value = JSON.parse(JSON.stringify(itemToEdit));
                }
            };

            const cancelEdit = () => {
                editingItem.value = null;
            };

            watch(currentDate, (newDate) => {
                newItem.value.date = newDate;
            });

            const isExpenseValid = computed(() => {
                return newExpense.amount > 0 && 
                       newExpense.description.trim() !== '' && 
                       newExpense.paidBy !== '' && 
                       newExpense.participants.length > 0;
            });

            // è¨ˆç®— TWD ç­‰å€¼é‡‘é¡
            const twdAmount = computed(() => {
                if (newExpense.amount > 0 && exchangeRate.value > 0) {
                    return newExpense.amount * exchangeRate.value;
                }
                return 0;
            });

            const formatCurrencyJPY = (amount) => {
                const roundedAmount = Math.round(amount); 
                return new Intl.NumberFormat('ja-JP', {
                    style: 'currency',
                    currency: 'JPY',
                    maximumFractionDigits: 0
                }).format(roundedAmount);
            };

            const formatCurrencyTWD = (amount) => {
                const roundedAmount = Math.round(amount); 
                return new Intl.NumberFormat('zh-TW', {
                    style: 'currency',
                    currency: 'TWD',
                    maximumFractionDigits: 0
                }).format(roundedAmount);
            };

            const totalAmount = computed(() => {
                return expenses.value.reduce((sum, exp) => sum + exp.amount, 0);
            });

            const averageCost = computed(() => {
                if (people.value.length === 0) return 0;
                return totalAmount.value / people.value.length;
            });

            // çµç®—é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼Œä½†ç¾åœ¨ä½¿ç”¨ Firestore è³‡æ–™
            const settlements = computed(() => {
                if (people.value.length === 0 || expenses.value.length === 0) return [];

                const balances = {};
                people.value.forEach(p => balances[p] = 0);

                for (const expense of expenses.value) {
                    if (expense.participants.length === 0) continue; 
                    const costPerPerson = expense.amount / expense.participants.length;
                    
                    balances[expense.paidBy] = (balances[expense.paidBy] || 0) + expense.amount; 
                    
                    for (const participant of expense.participants) {
                        balances[participant] = (balances[participant] || 0) - costPerPerson;
                    }
                }

                let creditors = [];
                let debtors = [];   

                const relevantPeople = people.value.filter(p => Math.abs(balances[p]) > 1);
                
                for (const person of relevantPeople) {
                    const balance = balances[person];
                    if (balance > 1) { 
                        creditors.push({ person, amount: balance });
                    } else if (balance < -1) { 
                        debtors.push({ person, amount: -balance });
                    }
                }

                const finalSettlements = [];
                let i = 0; 
                let j = 0; 

                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];

                    const transferAmount = Math.min(debtor.amount, creditor.amount);

                    finalSettlements.push({
                        debtor: debtor.person,
                        creditor: creditor.person,
                        amount: transferAmount
                    });

                    debtor.amount -= transferAmount;
                    creditor.amount -= transferAmount;

                    if (debtor.amount < 1) { 
                        i++;
                    }
                    if (creditor.amount < 1) { 
                        j++;
                    }
                }

                return finalSettlements;
            });


            // --- 3. åœ°åœ–èˆ‡å°èˆªé‚è¼¯ (ä¸è®Š) ---
            const userLatitude = ref(null);
            const userLongitude = ref(null);
            const locationError = ref('');
            const mapEmbedUrl = ref(''); 

            const generateMapEmbedUrl = () => {
                const locations = filteredItinerary.value.map(item => item.location);
                let fullQuery;
                if (locations.length > 0) {
                    fullQuery = `å¤§é˜ª ${locations.join(' and ')}`;
                } else {
                    fullQuery = 'å¤§é˜ªåŸ';
                }
                const url = `https://maps.google.com/maps?q=${encodeURIComponent(fullQuery)}&output=embed&z=12`;
                mapEmbedUrl.value = url;
            };

            const openItineraryMap = () => {
                if (filteredItinerary.value.length === 0) {
                    return;
                }
                const finalDestination = filteredItinerary.value[filteredItinerary.value.length - 1].location;
                const waypoints = filteredItinerary.value.slice(0, -1).map(i => i.location).join('|');
                const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(finalDestination)}&waypoints=${encodeURIComponent(waypoints)}&travelmode=driving`;
                window.open(url, '_blank');
            };

            const getCurrentLocation = () => {
                locationError.value = 'æ­£åœ¨å®šä½...';
                userLatitude.value = null;
                userLongitude.value = null;
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLatitude.value = position.coords.latitude;
                            userLongitude.value = position.coords.longitude;
                            locationError.value = '';
                        },
                        (error) => {
                            locationError.value = `ç„¡æ³•å–å¾—ä½ç½® (${error.code}): ${error.message}`;
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    locationError.value = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½ã€‚';
                }
            };
            
            // --- 4. å¤©æ°£èˆ‡åŒ¯ç‡é‚è¼¯ (ä¸è®Šï¼Œä½†ä½¿ç”¨ retryFetch) ---
            const weatherData = ref('è¼‰å…¥ä¸­...');
            const exchangeRate = ref(0.0);
            const exchangeRateText = ref('è¼‰å…¥ä¸­...');

            const fetchExchangeRate = async () => {
                exchangeRateText.value = 'è¼‰å…¥ä¸­...';
                const systemPrompt = "You are a specialized financial data tool. When asked for an exchange rate, provide only the numeric value of the rate, rounded to 4 decimal places, without any currency symbols or extra text.";
                const userQuery = "Current exchange rate for 1 JPY to TWD.";
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const result = await retryFetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const rate = parseFloat(text.trim());

                    if (!isNaN(rate) && rate > 0) {
                        exchangeRate.value = rate;
                        exchangeRateText.value = rate.toFixed(4);
                    } else {
                        throw new Error("Invalid rate returned.");
                    }
                } catch (error) {
                    exchangeRateText.value = 'ç„¡æ³•å–å¾— (è«‹ç¨å¾Œé‡è©¦)';
                    console.error("Failed to fetch exchange rate:", error);
                }
            };

            const fetchWeatherForOsaka = async () => {
                weatherData.value = 'è¼‰å…¥ä¸­...';
                const systemPrompt = "You are a specialized weather search tool. When asked for the current temperature, provide only the temperature in Celsius (Â°C) and the weather condition in a concise phrase, like '25Â°C, Sunny'. Do not include location name, time, or extra text.";
                const userQuery = "What is the current temperature and weather condition in Osaka, Japan in Celsius?";
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const result = await retryFetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        weatherData.value = text.trim();
                    } else {
                        throw new Error("API response text is empty or malformed.");
                    }
                } catch (error) {
                    weatherData.value = 'ç„¡æ³•è¼‰å…¥å¤©æ°£è³‡è¨Š';
                    console.error("Failed to fetch weather data after multiple retries.", error);
                }
            };
            
            // --- åˆå§‹åŒ–èˆ‡ç›£è½ ---
            
            watch([currentTab, filteredItinerary, currentDate], (newValues) => {
                if (currentTab.value === 'map') {
                    generateMapEmbedUrl();
                    nextTick(() => lucide.createIcons()); 
                }
            }, { deep: true });

            onMounted(() => {
                initFirebase(); // é–‹å§‹åˆå§‹åŒ– Firebase
                fetchWeatherForOsaka(); 
                fetchExchangeRate(); 
                nextTick(() => lucide.createIcons());
            });


            return {
                // Firebase ç‹€æ…‹
                userId,
                isDataReady,
                loadingError,
                // åŸºç¤ç‹€æ…‹
                currentTab,
                // è¡Œç¨‹
                itinerary,
                newItem,
                currentDate,
                dateList,
                currentDateDisplay,
                filteredItinerary,
                editingItem,
                addItem,
                deleteItem,
                editItem,
                saveEdit,
                cancelEdit,
                categoryMap,
                getCategoryInfo, 
                // åˆ†å¸³
                people,
                expenses,
                newPersonName,
                addPerson,
                removePerson,
                newExpense,
                addExpense,
                removeExpense,
                isExpenseValid,
                totalAmount,
                averageCost,
                settlements,
                formatCurrencyJPY,
                formatCurrencyTWD, 
                clearExpenses,
                exchangeRate,
                exchangeRateText,
                twdAmount,
                // åœ°åœ–
                openItineraryMap, 
                userLatitude,
                userLongitude,
                locationError,
                getCurrentLocation, 
                mapEmbedUrl, 
                // å¤©æ°£
                weatherData,
            };
        }
    };

    createApp(App).mount('#app');
    
    // ç›£è½ DOM è®ŠåŒ–é‡æ–°æ¸²æŸ“ Lucide åœ–æ¨™
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

</script>

</body>
</html>
